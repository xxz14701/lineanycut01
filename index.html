<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è²¼åœ–è‡ªè¨‚è£åˆ‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap');
        
        /* é‡å°é•·è¼©å„ªåŒ–çš„å…¨åŸŸè¨­å®š */
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #fff7ed; /* æº«æš–çš„ç±³è‰²èƒŒæ™¯ï¼Œä¸åˆºçœ¼ */
            color: #431407; /* æ·±å’–å•¡è‰²æ–‡å­—ï¼Œå°æ¯”åº¦é«˜ */
        }

        /* è£åˆ‡ç·šåŠ ç²—ï¼Œæ–¹ä¾¿çœ‹æ¸…æ¥š */
        .preview-box { position: relative; user-select: none; touch-action: none; cursor: crosshair; }
        .draggable-line { 
            stroke: #ff4500; /* é®®è±”ç´…æ©˜è‰² */
            stroke-width: 2; /* ç·šæ¢åŠ ç²— */
            cursor: ns-resize; 
            transition: stroke-width 0.2s; 
            filter: drop-shadow(0 2px 4px rgba(255,255,255,0.9)); /* åŠ ç™½é‚Šè®“ç·šæ›´æ˜é¡¯ */
        }
        .draggable-line-v { cursor: ew-resize; }
        .draggable-line:hover { stroke-width: 4; stroke: #ff0000; } /* æ»‘é¼ ç§»éå»è®Šæ›´ç²— */

        /* é€æ˜èƒŒæ™¯æ ¼å­åŠ å¤§ */
        .grid-bg { 
            background-image: linear-gradient(45deg, #e2e8f0 25%, transparent 25%), 
                              linear-gradient(-45deg, #e2e8f0 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #e2e8f0 75%), 
                              linear-gradient(-45deg, transparent 75%, #e2e8f0 75%); 
            background-size: 20px 20px; background-color: white; 
        }

        /* è‡ªå®šç¾©çš„å¤§å‹ Range Slider */
        input[type=range] {
            height: 30px;
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 40px;
            width: 40px;
            border-radius: 50%;
            background: #16a34a;
            cursor: pointer;
            margin-top: -12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 4px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 16px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 8px;
        }

        /* è¼‰å…¥å‹•ç•« */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        .loading-ring::before {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            background-color: white;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // æ•¸å­—å¢æ¸›æŒ‰éˆ•çµ„ä»¶
        const NumberControl = ({ label, value, onChange, min = 1, max = 10 }) => (
            <div className="bg-orange-50 p-4 rounded-2xl border-2 border-orange-200">
                <label className="block text-xl font-bold text-orange-900 mb-3 text-center">{label}</label>
                <div className="flex items-center justify-between gap-4">
                    <button 
                        onClick={() => onChange(Math.max(min, value - 1))}
                        className="w-16 h-16 rounded-full bg-white border-4 border-orange-300 text-orange-600 text-4xl font-black flex items-center justify-center shadow-md active:scale-95 transition-transform"
                    >
                        -
                    </button>
                    <span className="text-4xl font-black text-orange-800 tabular-nums">{value}</span>
                    <button 
                        onClick={() => onChange(Math.min(max, value + 1))}
                        className="w-16 h-16 rounded-full bg-orange-500 border-4 border-orange-600 text-white text-4xl font-black flex items-center justify-center shadow-md active:scale-95 transition-transform"
                    >
                        +
                    </button>
                </div>
            </div>
        );

        const App = () => {
            const [step, setStep] = useState(1);
            const [imgSrc, setImgSrc] = useState(null);
            
            const [cols, setCols] = useState(4);
            const [rows, setRows] = useState(3);
            const [vLines, setVLines] = useState([]);
            const [hLines, setHLines] = useState([]);
            
            const [isProcessing, setIsProcessing] = useState(false);
            const [finalImages, setFinalImages] = useState([]);
            
            const [targetColorHex, setTargetColorHex] = useState("#00FF00"); 
            const [colorTolerance, setColorTolerance] = useState(35);

            const containerRef = useRef(null);
            const imgRef = useRef(null);
            const workerRef = useRef(null);

            useEffect(() => {
                const workerScript = `
                    self.onmessage = function(e) {
                        const { imageBitmap, id, targetColor, tolerance } = e.data;
                        const w = imageBitmap.width;
                        const h = imageBitmap.height;
                        const canvas = new OffscreenCanvas(w, h);
                        const ctx = canvas.getContext('2d');
                        
                        ctx.clearRect(0, 0, w, h);
                        ctx.drawImage(imageBitmap, 0, 0);
                        
                        const imgData = ctx.getImageData(0, 0, w, h);
                        const data = imgData.data;

                        const tr = parseInt(targetColor.slice(1, 3), 16);
                        const tg = parseInt(targetColor.slice(3, 5), 16);
                        const tb = parseInt(targetColor.slice(5, 7), 16);
                        
                        const maxVal = Math.max(tr, tg, tb);
                        let dominantChannel = 'g'; 
                        if (maxVal === tr && tr > tg + 20) dominantChannel = 'r';
                        if (maxVal === tb && tb > tg + 20) dominantChannel = 'b';

                        const distThreshold = tolerance * 4.5; 
                        const ramp = 15; 

                        for (let i = 0; i < data.length; i += 4) {
                            if (data[i + 3] === 0) continue;

                            const r = data[i], g = data[i + 1], b = data[i + 2];
                            const dist = Math.sqrt((r - tr) ** 2 + (g - tg) ** 2 + (b - tb) ** 2);
                            
                            let alpha = 255;
                            if (dist < distThreshold) {
                                alpha = 0; 
                            } else if (dist < distThreshold + ramp) {
                                alpha = ((dist - distThreshold) / ramp) * 255;
                            }
                            
                            if (alpha < 255) {
                                data[i + 3] = Math.min(data[i + 3], alpha);
                            }

                            if (data[i + 3] > 0) { 
                                if (dominantChannel === 'g' && g > r && g > b) {
                                    data[i + 1] = (r + b) / 2;
                                } else if (dominantChannel === 'b' && b > r && b > g) {
                                    data[i + 2] = (r + g) / 2;
                                } else if (dominantChannel === 'r' && r > g && r > b) {
                                    data[i] = (g + b) / 2;
                                }
                            }
                        }
                        
                        ctx.putImageData(imgData, 0, 0);
                        canvas.convertToBlob({ type: 'image/png' }).then(blob => {
                            const reader = new FileReader();
                            reader.readAsDataURL(blob);
                            reader.onloadend = () => self.postMessage({ id, dataUrl: reader.result });
                        });
                    };
                `;
                const blob = new Blob([workerScript], { type: "text/javascript" });
                workerRef.current = new Worker(URL.createObjectURL(blob));
                workerRef.current.onmessage = (e) => {
                    setFinalImages(prev => [...prev, e.data].sort((a,b) => a.id - b.id));
                };
                return () => workerRef.current.terminate();
            }, []);

            const initLines = (c, r) => {
                const v = []; for(let i=1; i<c; i++) v.push((i/c)*100);
                const h = []; for(let i=1; i<r; i++) h.push((i/r)*100);
                setVLines(v);
                setHLines(h);
            };

            const updateCols = (newVal) => {
                setCols(newVal);
                initLines(newVal, rows);
            };

            const updateRows = (newVal) => {
                setRows(newVal);
                initLines(cols, newVal);
            };

            const onFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        setImgSrc(ev.target.result);
                        initLines(cols, rows);
                        setStep(2);
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            };

            const handleMouseMove = (e, type, index) => {
                if (e.buttons !== 1) return;
                const rect = containerRef.current.getBoundingClientRect();
                if (type === 'v') {
                    const newX = ((e.clientX - rect.left) / rect.width) * 100;
                    const newV = [...vLines];
                    newV[index] = Math.max(0, Math.min(100, newX));
                    setVLines(newV.sort((a,b) => a-b));
                } else {
                    const newY = ((e.clientY - rect.top) / rect.height) * 100;
                    const newH = [...hLines];
                    newH[index] = Math.max(0, Math.min(100, newY));
                    setHLines(newH.sort((a,b) => a-b));
                }
            };

            const startCutting = async () => {
                setIsProcessing(true);
                setFinalImages([]);
                
                const img = imgRef.current;
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                const xPoints = [0, ...vLines.map(p => (p/100)*canvas.width), canvas.width];
                const yPoints = [0, ...hLines.map(p => (p/100)*canvas.height), canvas.height];

                let count = 0;
                for (let r = 0; r < yPoints.length - 1; r++) {
                    for (let c = 0; c < xPoints.length - 1; c++) {
                        count++;
                        const x = xPoints[c];
                        const y = yPoints[r];
                        const w = xPoints[c+1] - x;
                        const h = yPoints[r+1] - y;

                        const subCanvas = document.createElement('canvas');
                        subCanvas.width = 370; subCanvas.height = 320;
                        const sCtx = subCanvas.getContext('2d');
                        sCtx.clearRect(0, 0, 370, 320);
                        
                        const padding = 10;
                        const targetW = 370 - (padding * 2);
                        const targetH = 320 - (padding * 2);
                        const ratio = Math.min(targetW / w, targetH / h); 
                        const dw = Math.floor(w * ratio);
                        const dh = Math.floor(h * ratio);
                        const dx = Math.floor((370 - dw) / 2);
                        const dy = Math.floor((320 - dh) / 2);
                        
                        sCtx.drawImage(canvas, x, y, w, h, dx, dy, dw, dh);
                        const bm = await createImageBitmap(subCanvas);
                        workerRef.current.postMessage({ 
                            imageBitmap: bm, 
                            id: count,
                            targetColor: targetColorHex,
                            tolerance: colorTolerance
                        }, [bm]);
                    }
                }
            };

            useEffect(() => {
                if (finalImages.length > 0 && finalImages.length === cols * rows) {
                    setIsProcessing(false);
                    setStep(3);
                }
            }, [finalImages]);

            return (
                <div className="min-h-screen font-sans pb-12">
                    {/* é ‚éƒ¨æ¨™é¡Œå€ */}
                    <div className="bg-orange-100 border-b-4 border-orange-300 py-6 px-4 mb-6 shadow-sm">
                        <div className="max-w-5xl mx-auto flex flex-col items-center text-center">
                            <h1 className="text-4xl md:text-5xl font-black text-orange-800 mb-2 tracking-tight">
                                âœ‚ï¸ è²¼åœ–è£åˆ‡å°å¹«æ‰‹
                            </h1>
                            <p className="text-xl text-orange-700 font-bold">
                                ç°¡å–®ä¸‰æ­¥é©Ÿï¼Œè¼•é¬†åšè²¼åœ–ï¼
                            </p>
                        </div>
                    </div>

                    <main className="max-w-5xl mx-auto px-4">
                        {/* æ­¥é©Ÿ 1: ä¸Šå‚³ */}
                        {step === 1 && (
                            <div className="animate-fade-in">
                                <div className="text-center mb-6">
                                    <span className="inline-block bg-green-600 text-white text-2xl font-black px-6 py-2 rounded-full mb-4 shadow-lg">ç¬¬ 1 æ­¥</span>
                                    <h2 className="text-3xl font-bold text-gray-800">è«‹å…ˆé¸ä¸€å¼µåœ–ç‰‡</h2>
                                </div>
                                
                                <input type="file" id="up" hidden onChange={onFileChange} accept="image/*" />
                                <label htmlFor="up" className="cursor-pointer group block bg-white border-4 border-dashed border-orange-300 rounded-[2rem] p-12 text-center shadow-lg hover:bg-orange-50 hover:border-orange-500 hover:scale-[1.02] transition-all duration-300">
                                    <div className="w-40 h-40 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner group-hover:bg-green-200 transition-colors">
                                        <svg className="w-20 h-20" fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4"/></svg>
                                    </div>
                                    <div className="text-4xl font-black text-gray-700 mb-4">é»é€™è£¡é¸ç…§ç‰‡</div>
                                    <div className="text-xl text-gray-500 bg-gray-100 inline-block px-4 py-1 rounded-lg">æ”¯æ´æ‰‹æ©Ÿç…§ç‰‡ã€JPGã€PNG</div>
                                </label>
                            </div>
                        )}

                        {/* æ­¥é©Ÿ 2: ç·¨è¼¯ */}
                        {step === 2 && (
                            <div className="animate-fade-in">
                                <div className="text-center mb-6">
                                    <span className="inline-block bg-blue-600 text-white text-2xl font-black px-6 py-2 rounded-full mb-4 shadow-lg">ç¬¬ 2 æ­¥</span>
                                    <h2 className="text-3xl font-bold text-gray-800">èª¿æ•´æ ¼å­èˆ‡å»èƒŒ</h2>
                                </div>

                                <div className="grid lg:grid-cols-2 gap-8 items-start">
                                    {/* å·¦å´ï¼šåœ–ç‰‡é è¦½ */}
                                    <div className="order-2 lg:order-1">
                                        <div className="bg-white p-3 rounded-3xl shadow-2xl border-4 border-gray-200">
                                            <h3 className="text-center text-xl font-bold text-gray-600 mb-2">ğŸ‘‡ ç”¨æ‰‹æŒ‡æ‹–æ›³æ©˜è‰²ç·šæ¢ ğŸ‘‡</h3>
                                            <div className="preview-box bg-slate-800 rounded-2xl overflow-hidden relative shadow-inner" ref={containerRef}>
                                                <img ref={imgRef} src={imgSrc} className="w-full block opacity-90" alt="Source" />
                                                <svg className="absolute inset-0 w-full h-full pointer-events-none filter drop-shadow-lg">
                                                    {vLines.map((pos, i) => (
                                                        <line key={`v-${i}`} x1={`${pos}%`} y1="0" x2={`${pos}%`} y2="100%" className="draggable-line draggable-line-v pointer-events-auto" onMouseMove={(e) => handleMouseMove(e, 'v', i)} />
                                                    ))}
                                                    {hLines.map((pos, i) => (
                                                        <line key={`h-${i}`} x1="0" y1={`${pos}%`} x2="100%" y2={`${pos}%`} className="draggable-line pointer-events-auto" onMouseMove={(e) => handleMouseMove(e, 'h', i)} />
                                                    ))}
                                                </svg>
                                            </div>
                                        </div>
                                        <button onClick={()=>setStep(1)} className="mt-6 w-full py-4 text-xl text-gray-500 font-bold hover:bg-gray-200 rounded-xl transition-colors">
                                            â† æ›ä¸€å¼µåœ–ç‰‡
                                        </button>
                                    </div>

                                    {/* å³å´ï¼šæ§åˆ¶é¢æ¿ */}
                                    <div className="order-1 lg:order-2 space-y-6">
                                        
                                        {/* 1. æ ¼å­è¨­å®š */}
                                        <div className="bg-white p-6 rounded-3xl shadow-lg border-2 border-orange-100">
                                            <h3 className="text-2xl font-black text-gray-800 border-b-4 border-orange-100 pb-3 mb-4 flex items-center gap-3">
                                                <span className="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-lg">1</span>
                                                è¦åˆ‡æˆå¹¾æ ¼ï¼Ÿ
                                            </h3>
                                            <div className="space-y-4">
                                                <NumberControl label="å·¦å³ (ç›´æ’)" value={cols} onChange={updateCols} />
                                                <NumberControl label="ä¸Šä¸‹ (æ©«æ’)" value={rows} onChange={updateRows} />
                                            </div>
                                        </div>

                                        {/* 2. é¡è‰²è¨­å®š */}
                                        <div className="bg-white p-6 rounded-3xl shadow-lg border-2 border-green-100">
                                            <h3 className="text-2xl font-black text-gray-800 border-b-4 border-green-100 pb-3 mb-4 flex items-center gap-3">
                                                <span className="bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-lg">2</span>
                                                è¦å»èƒŒçš„é¡è‰²ï¼Ÿ
                                            </h3>
                                            
                                            <div className="flex items-center gap-4 mb-6 bg-green-50 p-4 rounded-2xl border-2 border-green-200 cursor-pointer relative overflow-hidden">
                                                <input type="color" value={targetColorHex} onChange={e => setTargetColorHex(e.target.value)} className="absolute inset-0 w-[200%] h-[200%] opacity-0 cursor-pointer" />
                                                <div className="w-20 h-20 rounded-full border-4 border-white shadow-md flex-shrink-0" style={{backgroundColor: targetColorHex}}></div>
                                                <div className="flex-1">
                                                    <div className="text-xl font-bold text-green-900">é»é€™è£¡é¸é¡è‰²</div>
                                                    <div className="text-green-700">ç›®å‰é¸æ“‡ï¼š{targetColorHex}</div>
                                                </div>
                                            </div>

                                            <div className="bg-gray-50 p-4 rounded-2xl border-2 border-gray-200">
                                                <div className="flex justify-between mb-2">
                                                    <label className="text-xl font-bold text-gray-700">å»èƒŒå¼·åº¦</label>
                                                    <span className="text-xl font-black text-blue-600">{colorTolerance}</span>
                                                </div>
                                                <input type="range" min="1" max="100" value={colorTolerance} onChange={e => setColorTolerance(Number(e.target.value))} />
                                                <div className="flex justify-between text-gray-500 font-bold mt-2 text-sm">
                                                    <span>åˆ‡ä¸€é»é»</span>
                                                    <span>åˆ‡ä¹¾æ·¨é»</span>
                                                </div>
                                            </div>
                                        </div>

                                        <button onClick={startCutting} disabled={isProcessing} className="w-full bg-blue-600 hover:bg-blue-700 text-white text-3xl font-black py-8 rounded-[2rem] shadow-xl hover:shadow-2xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 transform hover:scale-[1.02] active:scale-95">
                                            {isProcessing && <div className="loading-ring w-8 h-8 relative border-2 border-white rounded-full"></div>}
                                            {isProcessing ? "è™•ç†ä¸­..." : "é–‹å§‹è£½ä½œè²¼åœ–ï¼"}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* æ­¥é©Ÿ 3: çµæœ */}
                        {step === 3 && (
                            <div className="animate-fade-in text-center">
                                <div className="mb-8">
                                    <span className="inline-block bg-red-500 text-white text-2xl font-black px-6 py-2 rounded-full mb-4 shadow-lg">ç¬¬ 3 æ­¥</span>
                                    <h2 className="text-4xl font-bold text-gray-800 mb-2">å®Œæˆå›‰ï¼</h2>
                                    <p className="text-xl text-gray-500">å¦‚æœæ»¿æ„çš„è©±ï¼Œè«‹æŒ‰ä¸‹é¢çš„ç¶ è‰²æŒ‰éˆ•ä¸‹è¼‰</p>
                                </div>
                                
                                <div className="bg-white p-6 rounded-3xl shadow-xl border border-gray-200 mb-8">
                                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                        {finalImages.map(img => (
                                            <div key={img.id} className="group relative bg-white rounded-xl shadow-md p-2 border border-gray-100">
                                                <div className="grid-bg aspect-[370/320] rounded-lg overflow-hidden relative">
                                                    <img src={img.dataUrl} className="w-full h-full object-contain" alt={`Sticker ${img.id}`} />
                                                </div>
                                                <div className="mt-2 font-bold text-gray-400">#{img.id}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="flex flex-col gap-4 max-w-xl mx-auto">
                                    <button onClick={() => {
                                        const zip = new JSZip();
                                        finalImages.forEach(img => zip.file(`${img.id.toString().padStart(2,'0')}.png`, img.dataUrl.split(',')[1], {base64:true}));
                                        zip.generateAsync({type:"blob"}).then(c => saveAs(c, "æˆ‘çš„è²¼åœ–.zip"));
                                    }} className="w-full bg-green-600 hover:bg-green-700 text-white text-3xl font-black py-8 rounded-[2rem] shadow-xl hover:shadow-green-200/50 transition-all flex items-center justify-center gap-3 transform hover:scale-[1.02]">
                                        <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                        ä¸‹è¼‰å…¨éƒ¨è²¼åœ– (ZIP)
                                    </button>

                                    <button onClick={() => setStep(2)} className="w-full py-4 text-xl text-gray-500 font-bold bg-white border-2 border-gray-300 rounded-2xl hover:bg-gray-100 transition-colors">
                                        ä¸æ»¿æ„ï¼Ÿå›ä¸Šä¸€æ­¥é‡èª¿
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
